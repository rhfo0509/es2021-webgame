<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ÏßÄÎ¢∞Ï∞æÍ∏∞</title>
    <style>
      table {
        border-collapse: collapse;
        user-select: none;
      }
      td {
        border: 1px solid #bbb;
        text-align: center;
        line-height: 25px;
        width: 25px;
        height: 25px;
        background: #888;
      }
      td.opened {
        background: white;
      }
      td.flag {
        background: red;
      }
      td.question {
        background: orange;
      }
    </style>
  </head>

  <body>
    <form id="form">
      <input placeholder="Í∞ÄÎ°ú Ï§Ñ" id="row" size="5" />
      <input placeholder="ÏÑ∏Î°ú Ï§Ñ" id="cell" size="5" />
      <input placeholder="ÏßÄÎ¢∞" id="mine" size="5" />
      <button id="create-btn">ÏÉùÏÑ±</button>
    </form>
    <div id="timer">0Ï¥à</div>
    <table id="table">
      <tbody></tbody>
    </table>
    <div id="result"></div>
    <script>
      const $timer = document.querySelector("#timer");
      const $tbody = document.querySelector("#table tbody");
      const $result = document.querySelector("#result");
      const $form = document.querySelector("#form");

      let row;
      let cell;
      let mine;

      const CODE = {
        NORMAL: -1,
        QUESTION: -2,
        FLAG: -3,
        QUESTION_MINE: -4,
        FLAG_MINE: -5,
        MINE: -6,
        OPENED: 0,
      };

      let openCount;
      let codeData;
      let startTime;
      let interval;

      function onSubmit(e) {
        e.preventDefault();
        row = parseInt(e.target.row.value);
        cell = parseInt(e.target.cell.value);
        mine = parseInt(e.target.mine.value);
        openCount = 0;
        $tbody.innerHTML = "";
        clearInterval(interval);

        codeData = createCodeData();
        createTable();

        startTime = new Date();
        interval = setInterval(() => {
          const time = Math.floor((new Date() - startTime) / 1000);
          $timer.textContent = `${time}Ï¥à`;
        }, 1000);

        $tbody.addEventListener("click", onLeftClick);
        $tbody.addEventListener("contextmenu", onRightClick);
      }

      function createCodeData() {
        const codeData = [];
        for (let i = 0; i < row; i++) {
          const rowCodeData = [];
          for (let j = 0; j < cell; j++) {
            rowCodeData.push(CODE.NORMAL);
          }
          codeData.push(rowCodeData);
        }

        return codeData;
      }

      function createTable() {
        for (let i = 0; i < row; i++) {
          const $tr = document.createElement("tr");
          for (let j = 0; j < cell; j++) {
            const $td = document.createElement("td");
            $tr.append($td);
          }
          $tbody.append($tr);
        }

        // createMines();
      }

      function createMines(ri, ci) {
        const candidate = Array(row * cell)
          .fill()
          .map((v, i) => i);

        const firstIndex = row * ri + ci;
        candidate.splice(firstIndex, 1);

        for (let i = 0; i < mine; i++) {
          const randomIndex = Math.floor(Math.random() * candidate.length);
          const selected = candidate.splice(randomIndex, 1)[0];
          codeData[Math.floor(selected / row)][selected % row] = CODE.MINE;
        }
      }

      function countMine(ri, ci) {
        let n = 0;

        const mines = [CODE.MINE, CODE.FLAG_MINE, CODE.QUESTION_MINE];

        mines.includes(codeData[ri - 1]?.[ci - 1]) && n++;
        mines.includes(codeData[ri - 1]?.[ci]) && n++;
        mines.includes(codeData[ri - 1]?.[ci + 1]) && n++;
        mines.includes(codeData[ri]?.[ci - 1]) && n++;
        mines.includes(codeData[ri]?.[ci + 1]) && n++;
        mines.includes(codeData[ri + 1]?.[ci - 1]) && n++;
        mines.includes(codeData[ri + 1]?.[ci]) && n++;
        mines.includes(codeData[ri + 1]?.[ci + 1]) && n++;

        return n;
      }

      function open(ri, ci) {
        if (codeData[ri]?.[ci] >= CODE.OPENED) return;

        const target = $tbody.children[ri]?.children[ci];

        if (!target) return;

        const mineCount = countMine(ri, ci);
        target.textContent = mineCount || "";
        target.className = "opened";

        // ÎÇ¥Í∞Ä ÌñàÎçò Ïã§Ïàò : codeDataÏùò Í∞íÏùÑ 0Ïù¥ÏÉÅÏúºÎ°ú Í∞±Ïã†ÌïòÏßÄ ÏïäÏùå
        // mineCountÍ∞Ä 0Ïù¥ Îê†Ïãú, openAroundÎ•º Ïû¨Í∑ÄÌò∏Ï∂úÌïòÍ≤å ÎêòÍ≥†, Ïù¥ Îïå cell Ï§ë ÌïòÎÇòÏùò mineCountÎèÑ 0Ïù¥ ÎêúÎã§Í≥† Í∞ÄÏ†ïÌï¥Î≥¥Ïûê.
        // Ïù¥Î†áÍ≤å ÎêòÎ©¥ Îòê Îã§Ïãú openAroundÍ∞Ä Ïû¨Í∑ÄÌò∏Ï∂úÎêòÍ≥†, Ï≤òÏùåÏóê ÏÑ†ÌÉùÎêú cellÏùÄ Ïó¨Ï†ÑÌûà -1 Í∞íÏùÑ Í∞ÄÏßÄÍ∏∞ ÎïåÎ¨∏Ïóê, Ïù¥Ï†Ñ cellÏùò openAroundÏóê ÏùòÌï¥ ÏÑ†ÌÉùÏù¥ ÎêòÏñ¥ Í≤∞Íµ≠ Î¨¥ÌïúÎ∞òÎ≥µÎêòÎäî ÏÇ¨ÌÉúÍ∞Ä Î∞úÏÉùÌïúÎã§.
        // Îî∞ÎùºÏÑú codeDataÏùò Í∞íÏùÑ mineCountÎ°ú ÏàòÏ†ïÌïòÏó¨ openÏóêÏÑú openCountÎ•º Ï¶ùÍ∞ÄÏãúÌÇ§ÏßÄ ÏïäÍ≥† returnÏù¥ ÎêòÎèÑÎ°ù ÎßåÎì†Îã§.
        // Ïù¥Î†áÍ≤å ÎêòÎ©¥ openAroundÏùò countÍ∞Ä undefinedÍ∞Ä ÎêòÏñ¥ openAroundÎ•º Ïû¨Í∑ÄÌò∏Ï∂úÌïòÏßÄ ÏïäÍ≤å ÎêúÎã§...
        codeData[ri][ci] = mineCount;
        openCount++;
        console.log(openCount);

        if (openCount === row * cell - mine) {
          $tbody.removeEventListener("click", onLeftClick);
          $tbody.removeEventListener("contextmenu", onRightClick);

          clearInterval(interval);
          setTimeout(() => {
            const time = (new Date() - startTime) / 1000;
            alert(`Ï∂ïÌïòÌï©ÎãàÎã§! Ï¥ù Í±∏Î¶∞ ÏãúÍ∞Ñ: ${time}Ï¥à`);
          }, 500);
          return;
        }

        return mineCount;
      }

      function openAround(ri, ci) {
        // Maximum call stack size exceeded Ìï¥Í≤∞
        // setTimeout(callback, 0)ÏùÑ Ïù¥Ïö©Ìï¥ backgroundÏôÄ task queueÎ°ú ÏûëÏóÖÏùÑ Î∂ÑÎ∞∞
        setTimeout(() => {
          const count = open(ri, ci);

          if (count === 0) {
            openAround(ri - 1, ci - 1);
            openAround(ri - 1, ci);
            openAround(ri - 1, ci + 1);
            openAround(ri, ci - 1);
            openAround(ri, ci + 1);
            openAround(ri + 1, ci - 1);
            openAround(ri + 1, ci);
            openAround(ri + 1, ci + 1);
          }
        }, 0);
      }

      // let normalCellFound = false;
      // let searched;
      // let firstClick = true;

      // function transferMine(ri, ci) {
      //   if (normalCellFound) return; // Ïù¥ÎØ∏ ÎπàÏπ∏ÏùÑ Ï∞æÏïòÏúºÎ©¥ Ï¢ÖÎ£å
      //   if (ri < 0 || ri >= row || ci < 0 || ci >= cell) return;
      //   if (searched[ri][ci]) return; // Ïù¥ÎØ∏ Ï∞æÏùÄ Ïπ∏Ïù¥Î©¥ Ï¢ÖÎ£å
      //   if (codeData[ri][ci] === CODE.NORMAL) {
      //     // ÎπàÏπ∏Ïù∏ Í≤ΩÏö∞
      //     normalCellFound = true;
      //     codeData[ri][ci] = CODE.MINE;
      //   } else {
      //     // ÏßÄÎ¢∞ Ïπ∏Ïù∏ Í≤ΩÏö∞ 8Î∞©Ìñ• ÌÉêÏÉâ
      //     searched[ri][ci] = true;
      //     transferMine(ri - 1, ci - 1);
      //     transferMine(ri - 1, ci);
      //     transferMine(ri - 1, ci + 1);
      //     transferMine(ri, ci - 1);
      //     transferMine(ri, ci + 1);
      //     transferMine(ri + 1, ci - 1);
      //     transferMine(ri + 1, ci);
      //     transferMine(ri + 1, ci + 1);
      //   }
      // }

      function showMines() {
        const mines = [CODE.MINE, CODE.QUESTION_MINE, CODE.FLAG_MINE];
        codeData.forEach((row, ri) => {
          row.forEach((cell, ci) => {
            if (mines.includes(cell)) {
              $tbody.children[ri].children[ci].className = "opened";
              $tbody.children[ri].children[ci].textContent = "üí£";
            }
          });
        });
      }

      function onLeftClick(e) {
        const target = e.target;
        const ri = target.parentNode.rowIndex;
        const ci = target.cellIndex;
        let cellCodeData = codeData[ri][ci];

        // 1. ÌïúÎ≤àÎèÑ ÌÅ¥Î¶≠ÌïòÏßÄ ÏïäÏïòÏùÑ Îïå ÌÅ¥Î¶≠Ìïú Ïπ∏ÏùÑ Ï†úÏô∏ÌïòÍ≥† Mine ÏÑ§Ïπò
        if (!openCount) {
          createMines(ri, ci);
        }

        // 2. ÌÅ¥Î¶≠Ìïú Ïπ∏Ïù¥ ÏßÄÎ¢∞Î©¥ ÏßÄÎ¢∞Î•º ÏòÆÍ∏∞Í∏∞
        // if (firstClick) {
        //   firstClick = false;
        //   searched = Array(row)
        //     .fill()
        //     .map(() => []);
        //   if (cellCodeData === CODE.MINE) {
        //     // Ï≤´ ÌÅ¥Î¶≠Ïù¥ ÏßÄÎ¢∞Î©¥
        //     transferMine(ri, ci); // ÏßÄÎ¢∞ ÏòÆÍ∏∞Í∏∞
        //     codeData[ri][ci] = CODE.NORMAL; // ÏßÄÍ∏à Ïπ∏ÏùÑ ÎπàÏπ∏ÏúºÎ°ú
        //     cellCodeData = CODE.NORMAL;
        //   }
        //   return;
        // }

        if (cellCodeData === CODE.MINE) {
          showMines();
          $tbody.removeEventListener("click", onLeftClick);
          $tbody.removeEventListener("contextmenu", onRightClick);
          clearInterval(interval);
          return;
        }

        openAround(ri, ci);
      }

      function onRightClick(e) {
        e.preventDefault();

        const target = e.target;
        const ri = target.parentNode.rowIndex;
        const ci = target.cellIndex;
        const cellCodeData = codeData[ri][ci];

        if (cellCodeData >= CODE.OPENED) return;
        else if (
          cellCodeData === CODE.QUESTION ||
          cellCodeData === CODE.QUESTION_MINE
        ) {
          codeData[ri][ci] =
            cellCodeData === CODE.QUESTION ? CODE.FLAG : CODE.FLAG_MINE;
          target.className = "flag";
          target.textContent = "üö©";
        } else if (
          cellCodeData === CODE.FLAG ||
          cellCodeData === CODE.FLAG_MINE
        ) {
          codeData[ri][ci] =
            cellCodeData === CODE.FLAG ? CODE.NORMAL : CODE.MINE;
          target.className = "";
          target.textContent = "";
        } else if (cellCodeData === CODE.NORMAL || cellCodeData === CODE.MINE) {
          codeData[ri][ci] =
            cellCodeData === CODE.NORMAL ? CODE.QUESTION : CODE.QUESTION_MINE;
          target.className = "question";
          target.textContent = "‚ùî";
        }
      }

      // 10 X 10 Table, 10 mines
      $form.addEventListener("submit", onSubmit);
    </script>
  </body>
</html>
